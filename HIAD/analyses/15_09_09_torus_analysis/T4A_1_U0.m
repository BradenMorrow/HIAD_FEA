% Preprocess nodes for FE model input
% T4A-1 torus

%% Input
% % T4A-1, stage 30
% CG = [0.00	66.19817200000000	-0.00000022138579	-0.19443948000000
%     11.25	64.84870700000000	12.89921000000000	-0.10945942000000
%     22.50	60.89859200000000	25.22502300000000	-0.04396576700000
%     33.75	54.61135200000000	36.49013800000000	0.02489790800000
%     45.00	46.44811100000000	46.44811100000000	0.04297510800000
%     56.25	36.72714100000000	54.96605000000000	0.14674102000000
%     67.50	25.52755600000000	61.62897300000000	0.17837665000000
%     78.75	13.12058100000000	65.96161400000000	0.12559814000000
%     90.00	0.00000014201591	67.58027200000000	0.15370081000000
%     101.25	-13.19249100000000	66.32313200000000	0.13824203000000
%     112.50	-25.65370500000000	61.93352300000000	0.16638622000000
%     123.75	-36.83535900000000	55.12801000000000	0.01226960300000
%     135.00	-46.48128900000000	46.48128900000000	-0.01560696700000
%     146.25	-54.47583600000000	36.39959000000000	0.01853666000000
%     157.50	-60.32777900000000	24.98858400000000	0.08439080200000
%     168.75	-64.12661300000000	12.75557600000000	0.03447284500000
%     180.00	-66.18028700000000	0.00000015819953	-0.06915072700000
%     191.25	-65.51379900000000	-13.03150500000000	-0.08138107000000
%     202.50	-61.91400700000000	-25.64562100000000	-0.04059851700000
%     213.75	-55.17235600000000	-36.86499000000000	0.01535842400000
%     225.00	-46.95488400000000	-46.95488400000000	-0.06163240100000
%     236.25	-36.83431000000000	-55.12644100000000	0.00021916049000
%     247.50	-25.50939600000000	-61.58512900000000	-0.05750331900000
%     258.75	-12.97770800000000	-65.24334500000000	-0.03228233100000
%     270.00	-0.00000000064319	-66.21018100000000	0.09885795200000
%     281.25	12.92475400000000	-64.97712600000000	0.13609723000000
%     292.50	25.36292700000000	-61.23152300000000	0.34713301000000
%     303.75	37.20321400000000	-55.67854400000000	0.23734830000000
%     315.00	47.35972900000000	-47.35972900000000	0.22851815000000
%     326.25	55.54537600000000	-37.11423300000000	0.15242654000000
%     337.50	61.53431300000000	-25.48834700000000	-0.06387913600000
%     348.75	65.01871700000000	-12.93302700000000	-0.18220978000000
%     360.00	66.19817200000000	-0.00000022138579	-0.19443948000000];


% T4A-1, stage 1
CG = [0.00	66.19330900000000	0.00000015955450	-0.19163656000000
    11.25	64.82355400000000	12.89420600000000	-0.10688538000000
    22.50	60.86953000000000	25.21298500000000	-0.04299092000000
    33.75	54.59033500000000	36.47609600000000	0.02573613200000
    45.00	46.43572800000000	46.43572800000000	0.04266585200000
    56.25	36.71900500000000	54.95387400000000	0.14787105000000
    67.50	25.52182200000000	61.61513000000000	0.18157393000000
    78.75	13.11807100000000	65.94899500000000	0.12951450000000
    90.00	-0.00000011655196	67.57875200000000	0.15732754000000
    101.25	-13.19515600000000	66.33652700000000	0.13757479000000
    112.50	-25.66572800000000	61.96254800000000	0.16497160000000
    123.75	-36.85968600000000	55.16441900000000	0.01120310900000
    135.00	-46.51722100000000	46.51722200000000	-0.01781910900000
    146.25	-54.51695500000000	36.42706400000000	0.01455856000000
    157.50	-60.37145400000000	25.00667500000000	0.08059603100000
    168.75	-64.16331700000000	12.76287700000000	0.03496587100000
    180.00	-66.20386100000000	-0.00000022887988	-0.06538107000000
    191.25	-65.51831800000000	-13.03240400000000	-0.07868515100000
    202.50	-61.90003700000000	-25.63983500000000	-0.03760336900000
    213.75	-55.14311900000000	-36.84545400000000	0.01729360300000
    225.00	-46.92124000000000	-46.92124000000000	-0.05947100700000
    236.25	-36.80956600000000	-55.08940800000000	0.00138849670000
    247.50	-25.49961500000000	-61.56151600000000	-0.05740807600000
    258.75	-12.97776000000000	-65.24360500000000	-0.03219685300000
    270.00	0.00000021560037	-66.22968300000000	0.09982061300000
    281.25	12.93049700000000	-65.00599500000000	0.13836480000000
    292.50	25.37647700000000	-61.26423500000000	0.34931068000000
    303.75	37.22537600000000	-55.71171200000000	0.23642191000000
    315.00	47.39582500000000	-47.39582500000000	0.22792761000000
    326.25	55.59225000000000	-37.14555400000000	0.15159501000000
    337.50	61.57914100000000	-25.50691500000000	-0.06153206700000
    348.75	65.04355000000000	-12.93796700000000	-0.17937087000000
    360.00	66.19330900000000	0.00000015955450	-0.19163656000000];

% CG(:,1) = CG(:,1) - 180;
% CG(:,1) = CG(:,1) + 90;

%% Fourier expansion
numpts = 100; % Number of spline points
n_wave = 4; % Number of waves
% nn = 1 + n; % Number of nodes

th = linspace(CG(1,1),CG(end,1),numpts)'; % Interpolation theta
% tt = interp1((th - th(1))/th(end),th,linspace(0,1,nn))' - 180; % Nodal theta

% Radius
r0 = sqrt(CG(:,2).^2 + CG(:,3).^2); % From input
r_spline = spline(CG(:,1),r0); % Create spline
r_int = ppval(r_spline,th); % Interpolate
[R0] = fourier(th*pi/180,r_int,n_wave,theta); % Fourier expansion
% [R0] = fourier(CG(:,1)*pi/180,r0,n_wave,theta); % Fourier expansion





% Out of plane
z0 = CG(:,4); % From input
z_spline = spline(CG(:,1),z0); % Create spline
z_int = ppval(z_spline,th); % Interpolate
[Z] = fourier(th*pi/180,z_int,n_wave,theta); % Fourier expansion

%% Sort and transform points
% % Remove repeated end entry
% tt(end) = [];
% tt(1) = 0;
% R(end) = [];
% Z(end) = [];
% 
% % Sort, positive x axis is zero degrees
% I = tt < -1e-5;
% tt = [tt(~I); tt(I) + 360];
% tt_rad = tt*pi/180;
% 
% R = [R(~I); R(I)];
% Z = [Z(~I); Z(I)];

% Transform to cartesian coordinates
X = R0.*cos(theta);
Y = R0.*sin(theta);

U0_tor2 = [X - R*cos(theta) Y - R*sin(theta) Z zeros(size(X,1),3)]';
U0_tor = U0_tor2(:);






%% Plot
CG2 = [CG; [360 CG(end,2:end)]];
figure(110)
clf

% R
subplot(2,1,1)
box on
hold on

plot(CG2(:,1),(CG2(:,2).^2 + CG2(:,3).^2).^.5,'bx','markersize',10,'linewidth',3) % Best fit torus
plot([theta*180/pi; 360],[R0; R0(1)],'r--','linewidth',2)
% plot([th; 360],[r_int; r_int(1)],'g-.','linewidth',2)

xlim([0 360])
ylim([65 68])

xlabel('\theta (degrees)')
ylabel('r (in)')

% Z
subplot(2,1,2)
box on
hold on

plot(CG2(:,1),CG2(:,4),'bx','markersize',10,'linewidth',3) % Best fit torus
plot([theta*180/pi; 360],[Z; Z(1)],'r--','linewidth',2)
% plot([th; 360],[z_int; z_int(1)],'g-.','linewidth',2)

xlim([0 360])
ylim([-.4 .4])

xlabel('\theta (degrees)')
ylabel('z (in)')

legend('Beast fit torus',sprintf('Fourier expansion (n = %g)',n_wave),...
    'location','south','orientation','horizontal')




a = 1;



